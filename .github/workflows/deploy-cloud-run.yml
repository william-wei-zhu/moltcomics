# Deploy to Google Cloud Run on push to main
#
# Prerequisites (one-time GCP setup):
#
#   # Enable required APIs
#   gcloud services enable run.googleapis.com artifactregistry.googleapis.com \
#     iamcredentials.googleapis.com secretmanager.googleapis.com --project=moltcomics
#
#   # Create Artifact Registry repo
#   gcloud artifacts repositories create moltcomics \
#     --repository-format=docker --location=us-central1 --project=moltcomics
#
#   # Create Cloud Run service account
#   gcloud iam service-accounts create moltcomics-run \
#     --display-name="MoltComics Cloud Run" --project=moltcomics
#
#   # Grant Cloud Run SA permissions
#   gcloud projects add-iam-policy-binding moltcomics \
#     --member="serviceAccount:moltcomics-run@moltcomics.iam.gserviceaccount.com" \
#     --role="roles/datastore.user"
#   gcloud projects add-iam-policy-binding moltcomics \
#     --member="serviceAccount:moltcomics-run@moltcomics.iam.gserviceaccount.com" \
#     --role="roles/storage.objectAdmin"
#   gcloud projects add-iam-policy-binding moltcomics \
#     --member="serviceAccount:moltcomics-run@moltcomics.iam.gserviceaccount.com" \
#     --role="roles/secretmanager.secretAccessor"
#
#   # Set up Workload Identity Federation
#   gcloud iam workload-identity-pools create github-pool \
#     --location=global --project=moltcomics
#   gcloud iam workload-identity-pools providers create-oidc github-provider \
#     --location=global --workload-identity-pool=github-pool \
#     --issuer-uri="https://token.actions.githubusercontent.com" \
#     --attribute-mapping="google.subject=assertion.sub,attribute.repository=assertion.repository" \
#     --project=moltcomics
#
#   # Create GitHub deployer service account
#   gcloud iam service-accounts create github-deployer \
#     --display-name="GitHub Actions Deployer" --project=moltcomics
#
#   # Grant deployer permissions
#   gcloud projects add-iam-policy-binding moltcomics \
#     --member="serviceAccount:github-deployer@moltcomics.iam.gserviceaccount.com" \
#     --role="roles/run.admin"
#   gcloud projects add-iam-policy-binding moltcomics \
#     --member="serviceAccount:github-deployer@moltcomics.iam.gserviceaccount.com" \
#     --role="roles/artifactregistry.writer"
#   gcloud iam service-accounts add-iam-policy-binding \
#     github-deployer@moltcomics.iam.gserviceaccount.com \
#     --role="roles/iam.workloadIdentityUser" \
#     --member="principalSet://iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/github-pool/attribute.repository/william-wei-zhu/moltcomics" \
#     --project=moltcomics
#   gcloud iam service-accounts add-iam-policy-binding \
#     moltcomics-run@moltcomics.iam.gserviceaccount.com \
#     --role="roles/iam.serviceAccountUser" \
#     --member="serviceAccount:github-deployer@moltcomics.iam.gserviceaccount.com" \
#     --project=moltcomics
#
#   # Store runtime secrets in Secret Manager
#   echo -n "VALUE" | gcloud secrets create FIREBASE_ADMIN_CLIENT_EMAIL --data-file=- --project=moltcomics
#   echo -n "VALUE" | gcloud secrets create FIREBASE_ADMIN_PRIVATE_KEY --data-file=- --project=moltcomics
#   echo -n "VALUE" | gcloud secrets create OPENAI_API_KEY --data-file=- --project=moltcomics
#
# Required GitHub Secrets:
#   GCP_WORKLOAD_IDENTITY_PROVIDER - projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/github-pool/providers/github-provider
#   GCP_SERVICE_ACCOUNT            - github-deployer@moltcomics.iam.gserviceaccount.com
#   NEXT_PUBLIC_FIREBASE_API_KEY
#   NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN
#   NEXT_PUBLIC_FIREBASE_PROJECT_ID
#   NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET
#   NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID
#   NEXT_PUBLIC_FIREBASE_APP_ID

name: Deploy to Cloud Run

on:
  push:
    branches: [main]

env:
  PROJECT_ID: moltcomics
  REGION: us-central1
  SERVICE: moltcomics
  REGISTRY: us-central1-docker.pkg.dev/moltcomics/moltcomics

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Build Docker image
        run: |
          docker build \
            --build-arg NEXT_PUBLIC_FIREBASE_API_KEY="${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN="${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_PROJECT_ID="${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET="${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID="${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_APP_ID="${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}" \
            -t ${{ env.REGISTRY }}/${{ env.SERVICE }}:${{ github.sha }} \
            .

      - name: Push Docker image
        run: docker push ${{ env.REGISTRY }}/${{ env.SERVICE }}:${{ github.sha }}

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ env.REGISTRY }}/${{ env.SERVICE }}:${{ github.sha }}
          flags: |
            --service-account=moltcomics-run@moltcomics.iam.gserviceaccount.com
            --allow-unauthenticated
          secrets: |
            FIREBASE_ADMIN_CLIENT_EMAIL=FIREBASE_ADMIN_CLIENT_EMAIL:latest
            FIREBASE_ADMIN_PRIVATE_KEY=FIREBASE_ADMIN_PRIVATE_KEY:latest
            OPENAI_API_KEY=OPENAI_API_KEY:latest
